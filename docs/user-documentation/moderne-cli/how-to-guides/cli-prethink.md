---
sidebar_label: Generating Prethink context locally
description: How to generate Prethink context for AI agents using the Moderne CLI.
---

# How to generate Prethink context with the CLI

Moderne Prethink generates structured context that gives AI coding agents a clear, accurate understanding of your codebase. While you can run Prethink recipes on the Moderne Platform, you can also generate Prethink context locally via the CLI.

In this guide, we'll walk you through how to do that.

## Prerequisites

This guide assumes that you have already [installed and configured the CLI](../getting-started/cli-intro.md#installation-and-configuration).

## Step 1: Checkout the repositories you want to generate context for

The first thing you'll need to do is come up with the list of repositories that you want to generate Prethink context for. Once you have that list, please ensure they are cloned to a shared directory locally. For instance, this might look like:

```bash
prethink-demo
├── service-a
├── service-b
└── shared-library
```

:::tip
You may find it useful to start by only cloning a small subset of your repositories locally so that you can test, build, and iterate quickly. Once you've confirmed everything is working as you want, you can then add more repositories as desired.
:::

We'd recommend using the [mod git sync command](../cli-reference.md#mod-git-sync) to create this shared directory. With it, you can clone repositories from a CSV file or from an existing organization.

## Step 2: Build the LSTs

With the repositories cloned, you now need to build or download LSTs to run Prethink recipes on:

```bash
mod build prethink-demo
```

## Step 3: Install Prethink recipes

Prethink is distributed as two modules. For most users, we recommend using the Moderne Prethink module. Install if via the following command:

```bash
mod config recipes jar install io.moderne.recipe:rewrite-prethink:LATEST
```

This module provides out-of-the-box discovery for Spring MVC, JAX-RS, Micronaut, Quarkus, JPA, Kafka, RabbitMQ, and more. Additionally, it integrates well with LLMs for code comprehension and test summaries.

Alternatively, if you have custom frameworks or want to build your own discovery recipes, install the OpenRewrite module which provides just the core building blocks:

```bash
mod config recipes jar install org.openrewrite.recipe:rewrite-prethink:LATEST
```

## Step 4: Run the Prethink recipe

`rewrite-prethink` includes a starter recipe which you can run as follows:

```bash
mod run prethink-demo --recipe io.moderne.prethink.UpdatePrethinkContextNoAiStarter
```

This recipe will:

* Discover service endpoints, database connections, external service calls, and messaging patterns
* Map test methods to implementation methods
* Generate a CALM architecture diagram
* Update agent configuration files

Once complete, you'll find the generated context in each repository's `.moderne/context/` directory:

```bash
service-a/
└── .moderne/
    └── context/
        ├── service-endpoints.csv
        ├── service-endpoints.md
        ├── database-connections.csv
        ├── database-connections.md
        ├── test-mapping.csv
        ├── test-mapping.md
        └── calm-architecture.json
```

The CSV files contain structured data that AI agents can parse directly. The markdown files provide human-readable descriptions. The CALM architecture JSON can be visualized with [CALM](https://calm.finos.org/)-compatible tools.

## Step 5: Create a custom Prethink recipe

You can customize which context is generated by creating your own Prethink recipe. Here's an example that focuses only on service endpoints:

```yaml
type: specs.openrewrite.org/v1beta/recipe
name: com.acme.MinimalPrethink
displayName: Minimal Prethink context
description: >-
  Generates basic Prethink context with service endpoints only.
recipeList:
  - io.moderne.prethink.calm.FindProjectMetadata
  - io.moderne.prethink.calm.FindServiceEndpoints
  - org.openrewrite.prethink.ExportContext:
      displayName: Service Endpoints
      shortDescription: REST and HTTP endpoints
      dataTables:
        - io.moderne.prethink.table.ServiceEndpoints
  - org.openrewrite.prethink.UpdateAgentConfig
```

:::warning
Make sure to give your recipes unique names so as not to conflict with installed starter recipes.
:::

Once complete, you can install the recipe to the local recipe marketplace with the command:

```bash
mod config recipes yaml install MyPrethink.yml
```

Next, run your custom recipe:

```bash
mod run prethink-demo --recipe com.acme.MinimalPrethink
```

## Using Prethink with AI agents

After generating Prethink context, your AI coding agents can consume it directly. The generated files are placed in locations that common agents automatically discover:

* **Claude Code**: References added to `CLAUDE.md`
* **Cursor**: References added to `.cursorrules`
* **GitHub Copilot**: References added to `.github/copilot-instructions.md`

The `UpdateAgentConfig` recipe in Prethink automatically updates these configuration files to reference the generated context.

## Keeping context up to date

Prethink context should be regenerated as your codebase evolves. You should consider:

* Running Prethink as part of your CI pipeline
* Scheduling periodic regeneration (e.g., weekly)
* Regenerating the context after every major refactor or dependency update

```bash
# Regenerate context for all repositories
mod run prethink-demo --recipe io.moderne.prethink.UpdatePrethinkContextNoAiStarter
```

## Next steps

Once you've arrived at a Prethink configuration that works for your organization, you should:

* Publish the recipe to your Moderne recipe marketplace
* Add Prethink generation to your CI/CD pipeline
* Explore AI-enhanced summaries by configuring an LLM provider
